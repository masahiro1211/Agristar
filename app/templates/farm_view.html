{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
<style>
    .farm-container {
        display: flex;
        height: calc(100vh - 120px);
    }
    
    .farm-sidebar {
        width: 320px;
        background-color: #f9f9f9;
        padding: 20px;
        border-right: 1px solid #eee;
        overflow-y: auto;
    }
    
    .farm-map {
        flex: 1;
        position: relative;
    }
    
    #farm-map {
        width: 100%;
        height: 100%;
    }
    
    .farm-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    
    .farm-header h1 {
        margin: 0 0 10px 0;
        font-size: 1.8rem;
    }
    
    .farm-coordinates {
        font-size: 0.9rem;
        color: #666;
    }
    
    .ndvi-section {
        margin-top: 30px;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .ndvi-section h2 {
        margin-bottom: 15px;
        font-size: 1.4rem;
        color: #4CAF50;
    }
    
    .ndvi-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .ndvi-form .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .ndvi-form button {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }
    
    .ndvi-form button:hover {
        background-color: #388E3C;
    }
    
    #ndvi-result {
        margin-top: 20px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
    }
    
    #ndvi-result p {
        margin: 5px 0;
    }
    
    .result-card {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    
    .result-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .result-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }
    
    .result-date {
        font-size: 0.9rem;
        color: #666;
    }
    
    .ndvi-values {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    
    .ndvi-value {
        text-align: center;
    }
    
    .value-label {
        font-size: 0.8rem;
        color: #666;
    }
    
    .value-number {
        font-size: 1.4rem;
        font-weight: bold;
    }
    
    .ndvi-visualization {
        height: 30px;
        background: linear-gradient(to right, #d73027, #fc8d59, #fee08b, #a6d96a, #1a9850);
        border-radius: 4px;
        margin-bottom: 10px;
    }
    
    .ndvi-scale {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
        color: #666;
    }
    
    .btn-back {
        display: block;
        text-align: center;
        margin-top: 20px;
        background-color: #f0f0f0;
        color: #333;
        text-decoration: none;
        padding: 10px;
        border-radius: 4px;
    }
    
    .btn-back:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="farm-container">
    <div class="farm-sidebar">
        <div class="farm-header">
            <h1>{{ farm.name }}</h1>
            <p class="farm-coordinates">
                緯度: {{ farm.coordinates[0].lat }}<br>
                経度: {{ farm.coordinates[0].lng }}
            </p>
        </div>
        
        <div class="ndvi-section">
            <h2>NDVI計算</h2>
            <form id="ndvi-form" class="ndvi-form">
                <div class="form-group">
                    <label for="ndvi-date">日付</label>
                    <input type="date" id="ndvi-date" name="ndvi-date" required>
                </div>
                <button type="submit" class="btn-register">計算</button>
            </form>
            
            <div id="ndvi-result" style="display: none;">
                <h3>NDVI結果</h3>
                <p>日付: <span id="result-date"></span></p>
                <p>最小NDVI: <span id="min-ndvi"></span></p>
                <p>平均NDVI: <span id="avg-ndvi"></span></p>
                <p>最大NDVI: <span id="max-ndvi"></span></p>
            </div>
        </div>
    </div>
    
    <div class="farm-map">
        <div id="farm-map"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 農場データ
        const farm = {
            name: "{{ farm.name }}",
            coordinates: {{ farm.coordinates|tojson }}
        };
        
        // 地図初期化
        const map = L.map('farm-map').setView([farm.coordinates[0].lat, farm.coordinates[0].lng], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // 農場の位置にマーカーを追加
        farm.coordinates.forEach(coord => {
            L.marker([coord.lat, coord.lng], {
                icon: L.icon({
                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                    iconSize: [10, 16], 
                    iconAnchor: [5, 16]
                })
            }).addTo(map);
        });
        
        // 農場の範囲を多角形で表示
        const polygon = L.polygon(farm.coordinates.map(coord => [coord.lat, coord.lng]), {
            color: '#4CAF50',
            fillColor: '#4CAF50',
            fillOpacity: 0.2
        }).addTo(map);
        
        // NDVI計算フォームの送信処理
        document.getElementById('ndvi-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('ndvi-date').value;
            
            // APIリクエストを送信
            fetch('/farm/{{ farm.id }}/ndvi', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ date: date })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 結果を表示
                    const result = data.result;
                    document.getElementById('result-date').textContent = result.date;
                    document.getElementById('min-ndvi').textContent = result.min_ndvi.toFixed(2);
                    document.getElementById('avg-ndvi').textContent = result.average_ndvi.toFixed(2);
                    document.getElementById('max-ndvi').textContent = result.max_ndvi.toFixed(2);
                    
                    // 結果表示エリアを表示
                    document.getElementById('ndvi-result').style.display = 'block';
                } else {
                    alert('エラーが発生しました: ' + data.error);
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                alert('計算中にエラーが発生しました');
            });
        });
    });
</script>
{% endblock %} 