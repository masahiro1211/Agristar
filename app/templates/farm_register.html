{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}">
<style>
    .farm-form {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 2;
        width: 320px;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 15px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .btn-register {
        background-color: #4CAF50;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-weight: bold;
    }
    
    .btn-register:hover {
        background-color: #388E3C;
    }
    
    .btn-back {
        background-color: #f0f0f0;
        color: #333;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        margin-top: 10px;
    }
    
    .btn-back:hover {
        background-color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div id="map"></div>
    
    <div class="farm-form">
        <h2>農場を登録</h2>
        <p>地図上で農場の位置を選択し、情報を入力してください。</p>
        
        <form id="farm-register-form">
            <div class="form-group">
                <label for="farm-name">農場名</label>
                <input type="text" id="farm-name" name="farm-name" required>
            </div>
            
            <div class="form-group">
                <label for="farm-lat">緯度</label>
                <input type="text" id="farm-lat" name="farm-lat" readonly>
            </div>
            
            <div class="form-group">
                <label for="farm-lng">経度</label>
                <input type="text" id="farm-lng" name="farm-lng" readonly>
            </div>
            
            <div class="form-group">
                <label for="farm-radius">半径 (m)</label>
                <input type="number" id="farm-radius" name="farm-radius" value="100" min="10" max="1000">
            </div>
            
            <button type="submit" class="btn-register">農場を登録</button>
            <a href="{{ url_for('main.index') }}" class="btn-back">戻る</a>
        </form>
    </div>
    
    <div id="map-instructions" class="map-instructions">
        <p><i class="fas fa-info-circle"></i> 地図上をクリックして農場の位置を選択してください</p>
        <button id="hide-instructions" class="hide-button"><i class="fas fa-times"></i></button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 地図初期化
        const map = L.map('map').setView([36.2048, 138.2529], 5);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // 選択した位置を示すマーカー
        let marker = null;
        
        // 地図クリックイベント
        map.on('click', function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // 入力フィールドに座標を設定
            document.getElementById('farm-lat').value = lat.toFixed(6);
            document.getElementById('farm-lng').value = lng.toFixed(6);
            
            // 既存のマーカーがあれば削除
            if (marker) {
                map.removeLayer(marker);
            }
            
            // 新しいマーカーを追加
            marker = L.marker([lat, lng]).addTo(map);
            
            // 選択した位置を中心に表示
            map.setView([lat, lng], 10);
        });
        
        // 操作説明の非表示ボタン
        document.getElementById('hide-instructions').addEventListener('click', function() {
            document.getElementById('map-instructions').style.display = 'none';
        });
        
        // フォーム送信処理
        document.getElementById('farm-register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const farmName = document.getElementById('farm-name').value;
            const farmLat = parseFloat(document.getElementById('farm-lat').value);
            const farmLng = parseFloat(document.getElementById('farm-lng').value);
            const farmRadius = parseInt(document.getElementById('farm-radius').value);
            
            if (!farmName || isNaN(farmLat) || isNaN(farmLng)) {
                alert('農場名と位置を正しく入力してください');
                return;
            }
            
            // 農場データを作成
            const farmData = {
                name: farmName,
                lat: farmLat,
                lng: farmLng,
                radius: farmRadius,
                created_at: new Date().toISOString()
            };
            
            // APIリクエストを送信
            fetch('/farm/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(farmData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('農場が登録されました');
                    window.location.href = '/';
                } else {
                    alert('エラーが発生しました: ' + data.error);
                }
            })
            .catch(error => {
                console.error('エラー:', error);
                alert('登録中にエラーが発生しました');
            });
        });
    });
</script>
{% endblock %} 